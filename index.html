<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>돈의 지도</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            background-color: #f8f9fa;
            color: #333;
            overflow: hidden;
        }
        .main-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        .graph-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            color: #2c3e50;
            margin: 0;
            font-weight: 700;
        }
        p {
            color: #7f8c8d;
            margin-top: 5px;
            margin-bottom: 20px;
        }
        svg {
            cursor: grab;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            background-color: #ffffff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .side-panel {
            width: 280px;
            flex-shrink: 0;
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            box-sizing: border-box; /* 높이 계산을 위해 추가 */
        }
        .side-panel h2 {
            margin-top: 0;
            font-size: 1.2em;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .side-panel ol {
            padding-left: 20px;
            margin: 0;
            font-size: 14px;
        }
        .side-panel li {
            margin-bottom: 18px;
            line-height: 1.6;
        }
        .link, .arrow, .node {
            transition: opacity 0.3s ease-in-out;
        }
        .link {
            stroke-opacity: 0.6;
            transition: stroke 0.2s ease-in-out, opacity 0.3s ease-in-out;
        }
        .arrow {
            transition: fill 0.2s ease-in-out, opacity 0.3s ease-in-out;
        }
        .node text {
            pointer-events: none;
            font-size: 12px;
            font-weight: bold;
            fill: #333;
        }
        .detail-text-group, .summary-text-group {
             pointer-events: none;
        }
        .detail-text {
            font-size: 10px;
            font-weight: normal;
        }
        .sub-detail-text {
            font-size: 9px;
            font-weight: normal;
            fill: #888;
        }
        .summary-text {
            font-size: 12px;
            font-weight: bold;
            fill: #e74c3c;
        }
        .card-sum-group {
            transition: opacity 0.3s ease-in-out;
        }
        .card-sum-text {
            font-size: 10px;
            font-weight: bold;
            fill: #e74c3c;
        }
        .node circle {
            transition: filter 0.2s ease-in-out, stroke 0.2s ease-in-out, stroke-width 0.2s ease-in-out;
        }
        .node.highlight circle {
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.2));
        }
        .badge text {
            fill: #fff;
            font-size: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="graph-container">
        <h1>돈의 지도</h1>
        <p>노드나 엣지를 클릭하여 돈의 흐름을 강조해보세요.</p>
    </div>
    <div class="main-container">
        <svg id="money-map"></svg>
        <div class="side-panel">
            <h2>탐색 가이드</h2>
            <ol>
                <li><strong>기본 보기:</strong> 각 원(노드)은 금융 항목을, 선(엣지)은 돈의 흐름을 나타냅니다. 선 중앙의 화살표는 돈이 이동하는 방향을 보여주며, 선의 굵기는 거래량의 크기를 의미합니다. 원의 크기는 각 항목의 총 금액을 나타냅니다.</li>
                <li><strong>탐색하기:</strong> 지도를 마우스로 드래그하여 움직이거나, 마우스 휠로 확대/축소할 수 있습니다.</li>
                <li><strong>노드 집중하기:</strong> 특정 노드를 클릭하면 해당 노드가 중심으로 이동하며 관련된 돈의 흐름이 강조됩니다.</li>
                <li><strong>엣지 집중하기:</strong> 특정 엣지(선)를 클릭하면 해당 거래와 연결된 두 노드만 선명하게 표시됩니다.</li>
                <li><strong>초기화:</strong> 그래프의 빈 공간을 클릭하면 모든 강조 효과가 사라지고 원래의 모습으로 돌아옵니다.</li>
            </ol>
        </div>
    </div>

    <script>
        // --- 데이터 정의 (모든 노드 포함) ---
        const nodes = [
            { id: "총 소득", group: 1, value: 350, count: 2 },
            { id: "홍길동", group: 1, value: 350, count: 9 },
            { id: "투자/저축", group: 2, value: 190, count: 3 }, 
            { id: "총 지출", group: 3, value: 160, count: 4, summary: "-2,698,300원" },
            { id: "K은행", group: 3, value: 80, parent: "총 지출", details: ["주거비", "1,200,000원", "K은행 ****-2847"] },
            { id: "W은행", group: 3, value: 60, parent: "총 지출", details: ["공과금", "156,800원", "W은행 ****-7890"] },
            { id: "H 카드", group: 4, value: 48, parent: "총 지출", details: ["교통비", "485,300원", "H카드 ****-5678"] },
            { id: "S카드", group: 4, value: 85, parent: "총 지출", details: ["식비", "856,200원", "S카드 ****-1234"] }
        ];

        const links = [
            { source: "총 소득", target: "홍길동", value: 350 },
            { source: "홍길동", target: "투자/저축", value: 170 },
            { source: "홍길동", target: "총 지출", value: 160 },
            { source: "총 지출", target: "K은행", value: 80 },
            { source: "총 지출", target: "W은행", value: 60 },
            { source: "총 지출", target: "H 카드", value: 10 }, // 월 납부액
            { source: "총 지출", target: "S카드", value: 10 }, // 월 납부액
            { source: "H 카드", target: "W은행", value: 10 },
            { source: "S카드", target: "W은행", value: 10 },
            { source: "총 소득", target: "투자/저축", value: 50 }
        ];

        // --- 시각화 설정 (크기 고정) ---
        const width = 720;
        const height = 580;

        const color = d3.scaleOrdinal(["#2ecc71", "#3498db", "#e74c3c", "#e74c3c"]);
        const incomeColor = "#2ecc71";
        const assetColor = "#3498db";
        const outcomeColor = "#e74c3c";

        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(180).strength(0.7))
            .force("charge", d3.forceManyBody().strength(-1000))
            .force("center", d3.forceCenter(width / 2, height / 2));

        const svg = d3.select("#money-map")
            .attr("width", width)
            .attr("height", height)
            .attr("viewBox", [0, 0, width, height]);
        
        d3.select(".side-panel").style("height", `${height}px`);

        const g = svg.append("g");
        
        const getNodeRadius = (d) => {
            let radius = 15 + Math.sqrt(d.value) * 1.5;
            if (d.id === '홍길동') {
                radius *= 1.2;
            }
            return radius;
        };

        const linkGroup = g.append("g")
            .selectAll("g")
            .data(links)
            .join("g")
            .style("cursor", "pointer");

        const linkLines = linkGroup.append("line")
            .attr("class", "link")
            .attr("stroke-width", d => {
                if (d.source.id === '총 지출') {
                    return Math.sqrt(d.target.value) / 2;
                }
                return Math.sqrt(d.value) / 2;
            })
            .attr("stroke", "#999");

        const linkArrows = linkGroup.append("path")
            .attr("class", "arrow")
            .attr("fill", "#999")
            .attr("d", "M0,-8L16,0L0,8");

        const nodeGroup = g.append("g")
            .attr("class", "nodes")
            .selectAll("g")
            .data(nodes)
            .join("g")
            .attr("class", "node")
            .call(drag(simulation));

        const circles = nodeGroup.append("circle")
            .attr("r", d => getNodeRadius(d))
            .attr("fill", "#ffffff")
            .attr("stroke", d => {
                if (d.id === '홍길동') return '#000000';
                return color(d.group);
            })
            .attr("stroke-width", 2);

        const nodeMainTexts = nodeGroup.append("text")
             .attr("text-anchor", "middle")
             .attr("y", d => {
                if (d.id === "W은행") return -8;
                if (d.details) return -5;
                if (d.summary) return -5;
                return 4;
            })
            .style("font-size", d => d.id === '홍길동' ? '14.4px' : '12px')
            .style("font-weight", "bold")
            .text(d => d.id);

        const wBankNode = nodeGroup.filter(d => d.id === 'W은행');
        const cardSumGroup = wBankNode.append("g")
            .attr("class", "card-sum-group")
            .style("opacity", 0);
        
        const cardSumText = cardSumGroup.append("text")
            .attr("class", "card-sum-text")
            .attr("text-anchor", "middle")
            .attr("y", 10);

        cardSumGroup.each(function() {
            const bbox = cardSumText.node().getBBox();
            d3.select(this).insert("rect", "text")
                .attr("x", bbox.x - 2)
                .attr("y", bbox.y - 1)
                .attr("width", bbox.width + 4)
                .attr("height", bbox.height + 2)
                .attr("fill", "white");
        });

        const detailGroup = nodeGroup.filter(d => d.details || d.summary)
            .append("g")
            .attr("class", "detail-text-group")
            .attr("transform", d => `translate(0, ${getNodeRadius(d) + 14})`);

        detailGroup.each(function(d) {
            const group = d3.select(this);
            const textElement = group.append("text").attr("text-anchor", "middle");

            if (d.details) {
                d.details.forEach((line, i) => {
                    textElement.append("tspan")
                        .attr("x", 0)
                        .attr("dy", i === 0 ? 0 : "1.2em")
                        .attr("class", i === 2 ? "sub-detail-text" : "detail-text")
                        .text(line);
                });
            } else if (d.summary) {
                textElement.attr("class", "summary-text").text(d.summary);
            }
            
            const bbox = textElement.node().getBBox();
            group.insert("rect", "text")
                .attr("x", bbox.x - 4)
                .attr("y", bbox.y - 2)
                .attr("width", bbox.width + 8)
                .attr("height", bbox.height + 4)
                .attr("fill", "white");
        });
        
        const badge = nodeGroup.filter(d => d.count)
            .append("g")
            .attr("class", "badge")
            .attr("transform", d => {
                const r = getNodeRadius(d);
                const x = r * 0.707;
                const y = -r * 0.707;
                return `translate(${x}, ${y})`;
            });

        badge.append("circle")
            .attr("r", 10)
            .attr("fill", d => {
                if (d.id === '홍길동') return '#000000';
                if (d.id === '총 지출') return '#888888'; 
                return color(d.group);
            });

        badge.append("text")
            .text(d => d.count)
            .attr("text-anchor", "middle")
            .attr("dy", "0.35em");
        
        nodeGroup.append("title")
            .text(d => `${d.id}\n금액: ${d.value}만원`);

        simulation.on("tick", () => {
            linkLines
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            linkArrows.attr("transform", d => {
                const midX = (d.source.x + d.target.x) / 2;
                const midY = (d.source.y + d.target.y) / 2;
                const angle = Math.atan2(d.target.y - d.source.y, d.target.x - d.source.x) * (180 / Math.PI);
                return `translate(${midX}, ${midY}) rotate(${angle})`;
            });

            nodeGroup.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        const zoomHandler = d3.zoom().scaleExtent([0.2, 5]).on("zoom", (event) => {
            g.attr("transform", event.transform);
        });
        svg.call(zoomHandler);
        
        let initialZoomDone = false;
        simulation.on("end", () => {
            if (initialZoomDone) return;
            const bbox = g.node().getBBox();
            const scale = Math.min(width / bbox.width, height / bbox.height) * 0.9;
            const translate = [
                width / 2 - scale * (bbox.x + bbox.width / 2),
                height / 2 - scale * (bbox.y + bbox.height / 2)
            ];
            const transform = d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale);
            
            svg.call(zoomHandler.transform, transform);
            initialZoomDone = true;
        });

        let selectedNode = null;
        let selectedLink = null;

        function updateHighlight() {
            const isNodeSelected = !!selectedNode;
            const isLinkSelected = !!selectedLink;

            nodeGroup.style("opacity", 1);
            linkGroup.style("opacity", 1);
            circles
                .attr("stroke", n => (n.id === '홍길동' ? '#000000' : color(n.group)))
                .attr("stroke-width", 2);
            linkLines.attr("stroke", "#999");
            linkArrows.attr("fill", "#999");
            nodeGroup.select(".card-sum-group").style("opacity", 0);

            if (!isNodeSelected && !isLinkSelected) return;
            
            nodeGroup.style("opacity", 0.2);
            linkGroup.style("opacity", 0.2);
            
            let nodesToHighlight = new Set();
            let linksToHighlight = new Set();
            
            if (isNodeSelected) {
                const d = selectedNode;
                nodesToHighlight.add(d);
                links.forEach(l => {
                    if (l.source === d) {
                        linksToHighlight.add(l);
                        nodesToHighlight.add(l.target);
                    }
                    if (l.target === d) {
                        linksToHighlight.add(l);
                        nodesToHighlight.add(l.source);
                    }
                });
            }

            if (isLinkSelected) {
                const l = selectedLink;
                linksToHighlight.add(l);
                nodesToHighlight.add(l.source);
                nodesToHighlight.add(l.target);
            }

            const highlightedNodes = nodeGroup.filter(n => nodesToHighlight.has(n));
            highlightedNodes.style("opacity", 1);
            highlightedNodes.select("circle").attr("stroke-width", 4);

            if (nodesToHighlight.has(nodes.find(n => n.id === 'W은행'))) {
                let textToShow = "+1,498,300원"; // Default sum
                if (isLinkSelected) {
                    if (selectedLink.source.id === 'S카드' && selectedLink.target.id === 'W은행') {
                        textToShow = "856,200원";
                    } else if (selectedLink.source.id === 'H 카드' && selectedLink.target.id === 'W은행') {
                        textToShow = "485,300원";
                    }
                }
                const wBankNode = nodeGroup.filter(n => n.id === 'W은행');
                const cardSumTextElement = wBankNode.select(".card-sum-text").text(textToShow);
                const cardSumGroupElement = wBankNode.select(".card-sum-group").style("opacity", 1);
                cardSumGroupElement.each(function() {
                    const bbox = cardSumTextElement.node().getBBox();
                    d3.select(this).select("rect")
                        .attr("x", bbox.x - 2)
                        .attr("y", bbox.y - 1)
                        .attr("width", bbox.width + 4)
                        .attr("height", bbox.height + 2);
                });
            }

            const highlightedLinks = linkGroup.filter(l => linksToHighlight.has(l));
            highlightedLinks.style("opacity", 1)
                .each(function(l) {
                    const colorLogic = (l) => {
                        if (l.source.id === '총 소득') return incomeColor;
                        if (l.target.id === '투자/저축') return assetColor;
                        return outcomeColor;
                    };
                    d3.select(this).select("line").attr("stroke", colorLogic(l));
                    d3.select(this).select(".arrow").attr("fill", colorLogic(l));
                });
        }

        nodeGroup.on("click", (event, d) => {
            event.stopPropagation();
            selectedLink = null;
            selectedNode = selectedNode === d ? null : d;
            updateHighlight();

            if (selectedNode) {
                let nodesToZoom = new Set();
                nodesToZoom.add(selectedNode);
                links.forEach(l => {
                    if (l.source === selectedNode) nodesToZoom.add(l.target);
                    if (l.target === selectedNode) nodesToZoom.add(l.source);
                });

                let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
                nodesToZoom.forEach(n => {
                    const radius = getNodeRadius(n);
                    minX = Math.min(minX, n.x - radius);
                    maxX = Math.max(maxX, n.x + radius);
                    minY = Math.min(minY, n.y - radius);
                    maxY = Math.max(maxY, n.y + radius);
                });

                const bboxWidth = maxX - minX;
                const bboxHeight = maxY - minY;
                const scale = Math.min(2, 0.9 / Math.max(bboxWidth / width, bboxHeight / height));
                const midX = (minX + maxX) / 2;
                const midY = (minY + maxY) / 2;

                svg.transition().duration(750).call(
                    zoomHandler.transform,
                    d3.zoomIdentity.translate(width / 2, height / 2).scale(scale).translate(-midX, -midY)
                );
            }
        });

        linkGroup.on("click", (event, d) => {
            event.stopPropagation();
            selectedNode = null;
            selectedLink = selectedLink === d ? null : d;
            updateHighlight();

            if (selectedLink) {
                const sourceRadius = getNodeRadius(d.source);
                const targetRadius = getNodeRadius(d.target);
                const bboxWidth = Math.abs(d.target.x - d.source.x) + sourceRadius + targetRadius;
                const bboxHeight = Math.abs(d.target.y - d.source.y) + sourceRadius + targetRadius;
                const scale = Math.min(2, 0.9 / Math.max(bboxWidth / width, bboxHeight / height));
                const midX = (d.source.x + d.target.x) / 2;
                const midY = (d.source.y + d.target.y) / 2;

                svg.transition().duration(750).call(
                    zoomHandler.transform,
                    d3.zoomIdentity.translate(width / 2, height / 2).scale(scale).translate(-midX, -midY)
                );
            }
        });

        svg.on("click", () => {
            selectedNode = null;
            selectedLink = null;
            updateHighlight();
        });

        function drag(simulation) {
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
                svg.style("cursor", "grabbing");
            }
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                if (selectedNode !== d) {
                   d.fx = null;
                   d.fy = null;
                }
                svg.style("cursor", "grab");
            }
            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }
    </script>
</body>
</html>
